# 关于路由

## 首先，啥是路由

通俗而言，路由就是“将一个数据包根据路由表进行转发的过程”。

而一条路由，就是一条“这个目标地址该被转发到哪个接口”的记录。

路由表，就是记录了很多个“这个目标地址该被转发到哪个接口”的表。

当然，路由表内还包含很多比如失效日期、MTU 之类的附属信息，并通过优化手段进行存储，具体实现可以自行去查询各厂源代码或 Google 。

比如，如下是一条在Linux内记录的去往`1.1.1.1`的路由

```
1.1.1.1 via 100.100.0.0 dev eth0 src 2.2.2.2
```

接下来我们来分段分析

* `1.1.1.1` 目标 IP，实际存储肯定是按照 IP 块来存储
* `via 100.100.0.0` 下一跳的 IP
* `dev eth0` 目标接口
* `src 2.2.2.2` 当这跳转发的来源是本机的时候，采用的源地址 IP

如果同时有`dev`和`via`，那么会根据`ARP`表将目标 MAC 重写为下一跳的 MAC（如果表内没有则在`dev`指定的接口查询），然后转发到`dev`指定的接口。

如果仅有`dev`没有`via`，那么会根据`ARP`表将目标 MAC 重写为目标地址的 MAC（如果表内没有则在`dev`指定的接口查询），然后转发到`dev`指定的接口。

如果仅有`via`没有`dev`，那么会递归查询到至少拥有`dev`的下一跳，根据原来的`via`和查询到的`dev`，按照第一条规则处理。

IPv6 同理，这里是一条在 Linux 内记录的去往`240c::6666`的路由

```
240c::6666 via fe80::1 dev eth0 src fd00:6868:6868::d33
```

* `240c::6666` 目标 IP，实际存储肯定是按照 IP 块来存储
* `via fe80::1` 下一跳的 IP
* `dev eth0` 目标接口
* `src fd00:6868:6868::d33` 当这跳转发的来源是本机的时候，采用的源地址 IP
