<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-sundry/new-filter">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.4.1">
<title data-rh="true">2. 过滤器进阶 | Bird Wiki 喵！</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://bird-wiki.zhiccc.net/docs/sundry/new-filter"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="2. 过滤器进阶 | Bird Wiki 喵！"><meta data-rh="true" name="description" content="在过滤公网路由的时候，只过滤::/0默认路由往往是不够的，因为这么做无法阻止盗播和错误路由，所以我们需要对过滤器进行进一步的修改。"><meta data-rh="true" property="og:description" content="在过滤公网路由的时候，只过滤::/0默认路由往往是不够的，因为这么做无法阻止盗播和错误路由，所以我们需要对过滤器进行进一步的修改。"><link data-rh="true" rel="canonical" href="https://bird-wiki.zhiccc.net/docs/sundry/new-filter"><link data-rh="true" rel="alternate" href="https://bird-wiki.zhiccc.net/docs/sundry/new-filter" hreflang="en"><link data-rh="true" rel="alternate" href="https://bird-wiki.zhiccc.net/docs/sundry/new-filter" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.57b11448.css">
<link rel="preload" href="/assets/js/runtime~main.7771ef0e.js" as="script">
<link rel="preload" href="/assets/js/main.f3588879.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}return t}()||function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><a class="navbar__brand" href="/"></a></div><div class="navbar__items navbar__items--right"><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebarViewport_Xe31"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/">起始页</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/sundry/definition">文章定义</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/sundry/introductions">注意事项（引言）</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/before-started/about-route">0. 在正式开始之前</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" href="/docs/sundry/start-your-bgp-session">1. BGP 连接和过滤器们</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/sundry/start-your-bgp-session">建立 BGP 并做最基础的过滤</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/sundry/new-filter">过滤器进阶</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/sundry/build-inet">内部网络配置</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/attachments/bird-2.0.10-install">2. 附录</a></div></li></ul></nav></div></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><span class="breadcrumbs__link">1. BGP 连接和过滤器们</span><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">过滤器进阶</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><h1>2. 过滤器进阶</h1><p>在过滤公网路由的时候，只过滤<code>::/0</code>默认路由往往是不够的，因为这么做无法阻止盗播和错误路由，所以我们需要对过滤器进行进一步的修改。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="公网路由应遵守的规则">公网路由应遵守的规则<a href="#公网路由应遵守的规则" class="hash-link" aria-label="Direct link to 公网路由应遵守的规则" title="Direct link to 公网路由应遵守的规则">​</a></h2><p>过滤器过滤要基于一套规则。下面我们来看一下HE的规则：</p><blockquote><h2 class="anchor anchorWithStickyNavbar_LWe7" id="hurricane-electric-route-filtering-algorithm-">Hurricane Electric Route Filtering Algorithm <a href="#hurricane-electric-route-filtering-algorithm" id="hurricane-electric-route-filtering-algorithm"></a><a href="#hurricane-electric-route-filtering-algorithm-" class="hash-link" aria-label="Direct link to hurricane-electric-route-filtering-algorithm-" title="Direct link to hurricane-electric-route-filtering-algorithm-">​</a></h2><p>This is the route filtering algorithm for customers and peers that have explicit filtering:</p><ol><li>Attempt to find an as-set to use for this network.</li></ol><p>1.1 In peeringdb, for this ASN, check for an IRR as-set name. Validate the as-set name by retrieving it. If it exists, use it.</p><p>1.2 In IRR, query for an aut-num for this ASN. If it exists, inspect the aut-num for this ASN to see if we can extract from their IRR policy an as-set for what they will announce to Hurricane by finding export or mp-export to AS6939, ANY, or AS-ANY. Precedence is as follows: The first match is used, &quot;export&quot; is checked before &quot;mp-export&quot;, and &quot;export: to AS6939&quot; is checked before &quot;export: to ANY&quot; or &quot;export: to AS-ANY&quot;. Validate the as-set name by retrieving it. If it exists, use it.</p><p>1.3 Check various internal lists maintained by Hurricane Electric&#x27;s NOC that map ASNs to as-set names where we discovered or were told of them. Validate the as-set name by retrieving it. If it exists, use it.</p><p>1.4 If no as-set name is found by the previous steps use the ASN.</p><ol><li>Collect the received routes for all BGP sessions with this ASN. This details both accepted and filtered routes.</li><li>For each route, perform the following rejection tests:</li></ol><p>3.1 Reject default routes 0.0.0.0/0 and ::/0.</p><p>3.2 Reject AS paths that use BGP AS_SET notation (i.e. {1} or {1 2}, etc). See <a href="https://datatracker.ietf.org/doc/draft-ietf-idr-deprecate-as-set-confed-set/" target="_blank" rel="noopener noreferrer">draft-ietf-idr-deprecate-as-set-confed-set</a>.</p><p>3.3 Reject prefix lengths less than minimum and greater than maximum. For IPv4 this is 8 and 24. For IPv6 this is 16 and 48.</p><p>3.4 Reject bogons (RFC1918, documentation prefix, etc).</p><p>3.5 Reject exchange prefixes for all exchanges Hurricane Electric is connected to.</p><p>3.6 Reject AS paths that exceed 50 hops in length. Excessive BGP AS Path Prepending is a Self-Inflicted Vulnerability.</p><p>3.7 Reject AS paths that use unallocated 32-bit ASNs between 1000000 and 4199999999. <a href="https://www.iana.org/assignments/as-numbers/as-numbers.xhtml" target="_blank" rel="noopener noreferrer">https://www.iana.org/assignments/as-numbers/as-numbers.xhtml</a></p><p>3.8 Reject AS paths that use AS 23456. AS 23456 should not be encountered in the AS paths of BGP speakers that support 32-bit ASNs.</p><p>3.9 Reject AS paths that use AS 0. As per RFC 7606, &quot;A BGP speaker MUST NOT originate or propagate a route with an AS number of zero&quot;.</p><p>3.10 Reject routes that have RPKI status INVALID_ASN or INVALID_LENGTH based on the origin AS and prefix.</p><ol><li>For each route, perform the following acceptance tests:</li></ol><p>4.1 If the origin is the neighbor AS, accept routes that have RPKI status VALID based on the origin AS and prefix.</p><p>4.2 If the prefix is an announced downstream route that is a subnet of an accepted originated prefix that was accepted due to either RPKI or an RIR handle match, accept the prefix.</p><p>4.3 If RIR handles match for the prefix and the peer AS, accept the prefix.</p><p>4.4 If this prefix exactly matches a prefix allowed by the IRR policy of this peer, accept the prefix.</p><p>4.5 If the first AS in the path matches the peer and path is two hops long and the origin AS is in the expanded as-set for the peer AS and either the RPKI status is VALID or there is an RIR handle match for the origin AS and the prefix, accept the prefix.</p><ol><li>Reject all prefixes not explicitly accepted</li></ol></blockquote><p>翻译</p><blockquote><h2 class="anchor anchorWithStickyNavbar_LWe7" id="hurricane-electric-的路由过滤算法-">Hurricane Electric 的路由过滤算法 <a href="#hurricaneelectric-de-lu-you-guo-lv-suan-fa" id="hurricaneelectric-de-lu-you-guo-lv-suan-fa"></a><a href="#hurricane-electric-的路由过滤算法-" class="hash-link" aria-label="Direct link to hurricane-electric-的路由过滤算法-" title="Direct link to hurricane-electric-的路由过滤算法-">​</a></h2><p>这是具有显式过滤的客户和对等方的路由过滤列表：</p><p>1.尝试查找该网络的 AS-SET</p><p>1.1 使用在 PeeringDB 中匹配该 ASN 所属 IRR 策略中的 AS-SET 如果它存在</p><p>1.2 在 IRR 中，查询此 ASN 的 aut-num。如果存在，请检查此 ASN 的 aut-num 以查看我们是否可以从他们的 IRR 策略中提取他们将通过查找到 AS6939、ANY 或 AS-ANY 的 export 或 mp-export 向 HE 宣布的内容的资产。 优先顺序如下：使用第一个匹配项，在“mp-export”之前检查“export”，在“export: to ANY”或“export: to AS-ANY”之前检查“export: to AS6939”。 如果存在，请使用查询来验证AS-SET。</p><p>1.3 检查由 HE 的 NOC 维护的各种内部列表，这些列表将 ASN 映射到我们发现或被告知它们的AS-SET。 如果存在，请使用通过查询来验证 AS-SET。</p><p>1.4 如果前面的步骤没有找到 AS-SET，则使用 ASN。</p><ol><li><p>收集与此 ASN 的所有 BGP 会话接收的路由。这个结果同时接受并进行过滤。</p></li><li><p>对于每条路由，执行以下拒绝测试：</p></li></ol><p>3.1 拒绝默认路由 0.0.0.0/0 和 ::/0。</p><p>3.2 拒绝使用 BGP AS_SET 表示法的 AS 路径（即 {1} 或 {1 2} 等）。请参阅 <a href="https://datatracker.ietf.org/doc/draft-ietf-idr-deprecate-as-set-confed-set/" target="_blank" rel="noopener noreferrer">draft-ietf-idr-deprecate-as-set-confed-set</a>。</p><p>3.3 拒绝前缀长度小于最小值和大于最大值。IPV4 中为 8 和 24，IPV6 为 16 和 48。</p><p>3.4 拒绝 bogons（RFC1918、文档前缀等）。</p><p>3.5 拒绝 HE 连接到的所有来自 IXP 的前缀。</p><p>3.6 拒绝长度超过 50 跳的 AS 路径。过多的 BGP AS 路径预置是一个自我造成的漏洞。</p><p>3.7 拒绝使用 1000000 到 4199999999 之间未分配的 32 位 ASN 中的 AS 路径。 请参阅 <a href="https://www.iana.org/assignments/as-numbers/as-numbers.xhtml" target="_blank" rel="noopener noreferrer">https://www.iana.org/assignments/as-numbers/as-numbers.xhtml</a></p><p>3.8 拒绝使用 AS23456 的 AS 路径。 在支持 32 位 ASN 的 BGP 广播的 AS 路径中不应遇到 AS23456。</p><p>3.9 拒绝使用 AS 0 的 AS 路径。根据 RFC 7606，“BGP 广播者不得发起或传播 AS 编号为零的路由”。</p><p>3.10 拒绝在源 ASN 或 IP 前缀的 RPKI 中含有 INVALID_ASN 或 INVALID_LENGTH 状态的路由</p><ol><li>对于每条路由，执行以下接受测试：</li></ol><p>4.1 据源 AS 和前缀接受 RPKI 状态为 VALID 的路由。</p><p>4.2 如果前缀是一个宣布的下游路由并是一个已接受的起源前缀的子网，该前缀由于 RPKI 或 RIR 句柄匹配而被接受，则接受该前缀。</p><p>4.3 如果 RIR 处理前缀和对等 AS 匹配，则接受前缀。</p><p>4.4 如果此前缀与该对等网络的 IRR 策略允许的前缀完全匹配，则接受该前缀。</p><p>4.5 如果路径中的第一个 AS 与对等网络匹配，并且路径为两跳，并且源 AS 在对等 AS 的扩展 AS-SET 中，并且 RPKI 状态为 VALID 或存在与源 AS 的 RIR 句柄匹配和前缀，接受前缀。</p><ol><li>拒绝所有未明确接受的前缀</li></ol></blockquote><ol><li>若路由为默认路由，或长度小于最小值/大于最大值，则拒绝。（对于 IPv4，这是 8 和 24。对于 IPv6 来说，这是 16 和 48。）</li><li>若路由的起源 ASN 为保留 ASN，或 BGP Path 中包含保留 ASN，则拒绝。</li><li>若路由为保留前缀，则拒绝。</li><li>若路由的 IRR 与 ASN 匹配，且 RPKI 不为 INVALID，则接受。</li></ol><p>总结而言，对于对等与下游，我们只应该接受路由长度大于最小值小于最大值，path 内不包含保留 ASN，不为保留前缀，且 IRR 匹配，RPKI 不为 INVALID 的路由。</p><p>而对于上游，我们仅验证 RPKI 不为 INVALID，路由长度大于最小值小于最大值，path 内不包含保留 ASN，不为保留前缀即可，不必验证 IRR。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="专有名词概念解释-">专有名词概念解释 <a href="#gai-nian" id="gai-nian"></a><a href="#专有名词概念解释-" class="hash-link" aria-label="Direct link to 专有名词概念解释-" title="Direct link to 专有名词概念解释-">​</a></h3><p>在正式改进自己的过滤器之前，我们需要了解以下概念。</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="irr-">IRR <a href="#irr" id="irr"></a><a href="#irr-" class="hash-link" aria-label="Direct link to irr-" title="Direct link to irr-">​</a></h4><p>IRR（Internet Routing Registry）是存储互联网路由对象的数据库，里面记录了某个前缀该被路由到哪个 ASN。IRR 实际上由很多个数据库组成，具体列表请看<a href="https://www.irr.net/docs/list.html" target="_blank" rel="noopener noreferrer">这里</a>。五大 RIR（ARIN，RIPE，AFRINIC，APNIC，LACNIC），比较老的 T1（例如LEVEL3，NTTCOM）都有自己的 IRR 数据库，同时还有一个商业数据库 RADb 和一个非营利数据库 ALTDB。这9个数据库是目前比较通用的数据库。</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="rpki-">RPKI <a href="#rpki" id="rpki"></a><a href="#rpki-" class="hash-link" aria-label="Direct link to rpki-" title="Direct link to rpki-">​</a></h4><p>关于 RPKI 的介绍我推荐查看<a href="https://blog.cloudflare.com/rpki/" target="_blank" rel="noopener noreferrer">这篇文章</a>。简而言之，RPKI 也可以用来将 ASN 与路由关联在一起，但与 IRR 的区别是 RPKI 需要使用证书签名，使用它可以有效地防止路由劫持。</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="as-set-">AS-SET <a href="#as-set" id="as-set"></a><a href="#as-set-" class="hash-link" aria-label="Direct link to as-set-" title="Direct link to as-set-">​</a></h4><p>AS-SET，顾名思义，一个 AS 的集合。一个 AS-SET 内通常要包含自己以及自己的下游的 ASN。AS-SET 允许嵌套。</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="bgp-community-">BGP Community <a href="#bgp-community" id="bgp-community"></a><a href="#bgp-community-" class="hash-link" aria-label="Direct link to bgp-community-" title="Direct link to bgp-community-">​</a></h4><p>BGP Community（也称 BGP 社区） 类似于给路由的标签，对等方可以根据标签内容来做出自己的选择。</p><p>BGP Community 有如下三种类型：</p><ul><li><code>BGP Community</code> (BGP 社区)，为一个4字节的值，在 BIRD 内显示为<code>(2byte ASN,2byte value)</code>，前二字节为 ASN，后二字节由 AS 自由分配。由于使用它需要一个 2byte 的 ASN（目前申请比较困难），所以一般在大 ISP 中能见到，或者使用保留 ASN。</li><li><code>BGP Extended Community</code>(BGP 扩展社区)，在BIRD内一般表示为<code>(type,administrator,value)</code>，为一个八字节的值，前二字节为类型，后六字节为管理员和分配的编号，由 AS 自行分配。它比较著名的应用位于 MPLS-VPN 内。</li><li><code>BGP Large Community</code>(BGP 大型社区)，在BIRD内一般表示为<code>(4byte ASN,4byte value,4byte value)</code>，为一个12字节的值，前四字节为 ASN，中间四字节与后四字节由 AS 自由分配。它被开发的主要原因是因为4字节 ASN 不能用于普通的 BGP 社区。</li></ul><p>目前，在公网上应用比较广的主要为<code>BGP Community</code>与<code>BGP Large Community</code></p><p>RFC 要求所有支持 BGP 社区的路由器必须处理知名的 BGP 社区，也就是<code>NO_EXPORT</code>, <code>NO_ADVERTISE</code>和<code>NO_EXPORT_SUBCONFED</code>。在默认情况下，BIRD 会自动处理这些 BGP 社区。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="bird-的基础语法解释-">BIRD 的基础语法解释 <a href="#guo-lv-qi" id="guo-lv-qi"></a><a href="#bird-的基础语法解释-" class="hash-link" aria-label="Direct link to bird-的基础语法解释-" title="Direct link to bird-的基础语法解释-">​</a></h2><p>以下内容摘自<a href="https://soha.moe/post/bird-bgp-kickstart.html" target="_blank" rel="noopener noreferrer"> Soha 的文章</a>：</p><blockquote><p>和 Juniper、Cisco 等路由器，或 FRR（Quagga）等路由软件不同，写 BIRD 的配置文件就像是在写程序，如果你是个程序员，那么上手应该会很快。正因如此，它也有着和常见编程语言所类似的语法。下面则是一些基础语法。</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="杂项-">杂项 <a href="#za-xiang" id="za-xiang"></a><a href="#杂项-" class="hash-link" aria-label="Direct link to 杂项-" title="Direct link to 杂项-">​</a></h4><p>用 <code>/* */</code> 包起来的内容是注释，<code>#</code> 至其所在行行末的内容也是注释。</p><p>分号 <code>;</code> 标示着一个选项或语句的结束，而花括号 <code>{ }</code> 内则是多个选项或语句。</p><p>在 BIRD 的配置文件中，有协议实例（<code>protocol &lt;proto&gt; &lt;name&gt; {}</code>），过滤器（<code>filter &lt;name&gt; [local_variables] {}</code>），函数（<code>function &lt;name&gt; [local_variables] {}</code>）可以定义，这些将在下文各部分选择性挑重点介绍。</p><p><code>print</code> 用来输出内容，这些会输出在 BIRD 的日志文件中，在使用 systemd 的系统中，可以使用 <code>journalctl -xeu bird.service</code> 查看。</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="变量与常量-">变量与常量 <a href="#bian-liang-yu-chang-liang" id="bian-liang-yu-chang-liang"></a><a href="#变量与常量-" class="hash-link" aria-label="Direct link to 变量与常量-" title="Direct link to 变量与常量-">​</a></h4><p>变量名、常量名、协议实例名、过滤器名、函数名等，都遵循着这样的规则：必须以下划线或字母开头，名称内也只能有字母、数字、下划线。比如 <code>Soha233</code>、<code>_my_filter</code>、<code>bgp_4842</code> 都是合法的名字。当然在 BIRD 中有例外，如果一个名字用单引号括起来，那么我们还可以用冒号、横线、点，比如 <code>&#x27;2.333:what-a-strange-name&#x27;</code>，只不过不推荐这么用就是了。</p><p>使用 <code>define</code> 定义常量，如 <code>define LOCAL_AS = 65550</code>。</p><p>BIRD 中可以针对很多变量类型定义集合。集合用一对方括号定义，如 <code>[1, 2, 3, 4]</code>。集合可以用范围来快速生成，比如 <code>[1, 2, 10..13]</code> 就会生成为 <code>[1, 2, 10, 11, 12, 13]</code>。范围的写法还可以用在社区属性中，如 <code>[(64512, 100..200)]</code>，在社区属性中还可以用通配符，如 <code>[(1, 2, *)]</code>。</p><p>前缀的集合中的范围写法较为复杂，<code>[prefix{low, high}]</code>，<code>prefix</code> 是一个用于匹配的前缀，<code>low</code> 和 <code>high</code> 两个值限制了它的 CIDR 长度。<code>[192.168.1.0/24{16,30}]</code> 表示的是包含或被包含于 192.168.1.0/24 且 CIDR 在 16-30 之间的前缀，例如 <code>192.168.0.0/20</code> 和 <code>192.168.1.0/29</code> 均属于这个集合，而 <code>192.168.233.0/24</code> 不属于。这样子的写法可能过于麻烦，所以 BIRD 中也使用加号和减号提供了两种便捷的写法，如 <code>[2001:db8:10::/44+, 2001:db8:2333::/48-]</code> 则等价于 <code>[2001:db8:10::/44{44,128}, 2001:db8:2333::/48{0,48}]</code>。</p><p>在 BIRD 中还有一类特殊的变量类型，他们都是列表，<code>bgppath</code>（AS Path，路由的 <code>bgp_path</code> 属性）、<code>clist</code>（BGP Community 列表，路由的 <code>bgp_community</code> 属性）、<code>eclist</code>（BGP Extended Community 列表，路由的 <code>bgp_ext_community</code> 属性）、<code>lclist</code>（BGP Large Community 列表，路由的 <code>bgp_large_community</code> 属性）都是这类变量，他们的操作有非常特殊的用法。下面的代码展示了 <code>bgppath</code> 的用法。<code>clist/eclist/lclist</code> 与之类似，但是它们只能使用其中的 <code>empty</code>、<code>len</code>、<code>add</code>、<code>delete</code>、<code>filter</code>。</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">function foo()</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">bgppath P;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">bgppath P2; {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"> print &quot;path 中第一个元素是&quot;, P.first, &quot;，最后一个元素是&quot;, P.last;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"> # 第一个元素可以认为是邻居的 ASN，最后一个元素是宣告这条路由的 ASN</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"> # 这两个在 P 中没有元素的时候是 0</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"> print &quot;path 的长度是&quot;, P.len;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"> if P.empty then {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">     print &quot;path 为空&quot;;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"> }</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"> P.prepend(233); # 在 path 的第一个位置插入元素</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"> P.delete(233); # 删除 path 中所有等于 233 的元素</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"> P.delete([64512..65535]); # 删除 path 中所有属于集合 [64512..65535] 的元素</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"> P.filter([64512..65535]); # 只在 path 中留下集合 [64512..65535] 中出现的元素</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"> # 如果不想改变 P，可以使用下面这样的方法将操作后的结果存入 P2</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"> P2 = delete(P, 233)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"> P2 = filter(P, [64512..65535])</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>变量只能定义在函数或过滤器的最开头（左花括号外面），关于变量类型的更详细信息，请移步<a href="https://bird.network.cz/?get_doc&amp;v=20&amp;f=bird.html#ss5.2" target="_blank" rel="noopener noreferrer">官方文档相关部分</a>。</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="操作符-">操作符 <a href="#cao-zuo-fu" id="cao-zuo-fu"></a><a href="#操作符-" class="hash-link" aria-label="Direct link to 操作符-" title="Direct link to 操作符-">​</a></h4><p>在 BIRD 中有很多常见的操作符。如 <code>+</code>、<code>-</code>、<code>*</code>、<code>/</code>、<code>()</code> 这些基本的算数操作符，有等于 <code>a = b</code>、不等于 <code>a != b</code>、大于 <code>a &gt; b</code>、大于等于 <code>a &gt;= b</code>、小于 <code>a &lt; b</code>、小于等于 <code>a &lt;= b</code> 这些比较符，有与 <code>&amp;&amp;</code>、或 <code>||</code>、非 <code>!</code> 这三种逻辑操作符。还有 <code>~</code> 和 <code>!~</code> 这两种判断包含或者不包含的操作符。包含操作符的用法写在附录 3 中。</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="分支-">分支 <a href="#fen-zhi" id="fen-zhi"></a><a href="#分支-" class="hash-link" aria-label="Direct link to 分支-" title="Direct link to 分支-">​</a></h4><p>过滤器和函数中的语句都是顺序执行的。同时支持 <code>case</code> 和 <code>if</code> 两种分支语句。在 BIRD 中是不支持循环的。</p><p><code>if</code> 的写法如下：</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">if 6939 ~ bgp_path then {   # 只要 AS Path 中有 6939</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"> bgp_local_pref = 233;   # 就将这条路由的 Local Preference 调为 233</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">} else {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"> bgp_local_pref = 2333;  # 否则设为 2333</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><code>case</code> 的写法如下：</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">case arg1 {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"> 2: print &quot;two&quot;; print &quot;I can do more commands without {}&quot;;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"> #  ^ case 不需要花括号就能在一个分支中写下更多语句。</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"> 3..5: print &quot;three to five&quot;;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"> else: print &quot;something else&quot;;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>在 BIRD 中，if 和 case 的写法均与常见编程语言略有不同。</p></blockquote><p>BIRD 的包含 <code>~</code> 和不包含 <code>!~</code> 操作符能用于下表中所示的类型。<code>~</code> 或者 <code>!~</code> 左边的东西叫做左操作数（是的，它不一定是数字，也可以是其它类型），右边的东西叫做右操作数，对应表如下。(摘自<a href="https://soha.moe/post/bird-bgp-kickstart.html" target="_blank" rel="noopener noreferrer"> Soha 的文章</a></p><table><thead><tr><th align="center">左操作数类型</th><th align="center">右操作数类型</th><th align="center">样例</th><th align="center">说明</th></tr></thead><tbody><tr><td align="center"><code>bgppath</code></td><td align="center"><code>bgpmask</code></td><td align="center"><code>bgp_path ~ [= * 64512 64513 * =]</code></td><td align="center">bgp_path 符合右边描述的模式则为真</td></tr><tr><td align="center"><code>int</code></td><td align="center"><code>bgppath</code></td><td align="center"><code>64512 ~ bgp_path</code></td><td align="center">左边被包含于右边则为真</td></tr><tr><td align="center"><code>pair</code>/<code>quad</code>/<code>ip4</code></td><td align="center"><code>clist</code></td><td align="center"><code>(123, 456) ~ bgp_community</code></td><td align="center">左边被包含于右边则为真，<code>pair</code>、<code>quad</code>、<code>ip4</code> 都是 32 位的，所以它们等价</td></tr><tr><td align="center"><code>ec</code></td><td align="center"><code>eclist</code></td><td align="center"><code>(rt, 10, 3) ~ bgp_ext_community</code></td><td align="center">左边被包含于右边则为真</td></tr><tr><td align="center"><code>lc</code></td><td align="center"><code>lclist</code></td><td align="center"><code>(4842, 0, 0) ~ bgp_large_community</code></td><td align="center">左边被包含于右边则为真</td></tr><tr><td align="center"><code>string</code></td><td align="center"><code>string</code></td><td align="center"><code>proto ~ &quot;bgp_*&quot;</code></td><td align="center">左边的字符串符合右边的模式（类 shell）就为真</td></tr><tr><td align="center"><code>ip</code></td><td align="center"><code>prefix</code></td><td align="center"><code>1.1.1.1 ~ 1.0.0.0/8</code></td><td align="center">IP 被包含于某前缀则为真</td></tr><tr><td align="center"><code>prefix</code></td><td align="center"><code>prefix</code></td><td align="center"><code>1.1.1.0/24 ~ 1.0.0.0/8{16,24}</code></td><td align="center">左边的前缀被包含于右边的前缀则为真</td></tr><tr><td align="center"><code>prefix</code></td><td align="center"><code>prefix set</code></td><td align="center"><code>1.1.1.0/24 ~ [1.0.0.0/24, 1.1.0.0/22]</code></td><td align="center">左边的前缀被包含于右边任意一个前缀则为真</td></tr><tr><td align="center"><code>path</code></td><td align="center"><code>int set</code></td><td align="center"><code>bgp_path ~ [233, 2333, 64512]</code></td><td align="center">左右两边交集非空即为真</td></tr><tr><td align="center"><code>clist</code></td><td align="center"><code>pair set</code></td><td align="center"><code>bgp_community ~ [(0, 6939), (1, 2333)]</code></td><td align="center">左右两边交集非空即为真</td></tr><tr><td align="center"><code>eclist</code></td><td align="center"><code>ec set</code></td><td align="center"><code>bgp_ext_community ~ [(rt, 1, 30), (ro, 2, *)]</code></td><td align="center">左右两边交集非空即为真</td></tr><tr><td align="center"><code>lclist</code></td><td align="center"><code>lc set</code></td><td align="center"><code>bgp_large_community ~ [(1, 2, 100..233)]</code></td><td align="center">左右两边交集非空即为真</td></tr></tbody></table><p>通过以上的解释，你应该能了解 BIRD 中大概的判断方式。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="与对等-peering-连接的过滤器定义">与对等 (Peering) 连接的过滤器定义<a href="#与对等-peering-连接的过滤器定义" class="hash-link" aria-label="Direct link to 与对等 (Peering) 连接的过滤器定义" title="Direct link to 与对等 (Peering) 连接的过滤器定义">​</a></h2><p>在了解了上面的过滤方法后，我们可以写出如下的过滤器</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">function general_check(){ # 返回true则拒绝，返回false则允许 (数据集来源：附录-基础过滤定义)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    if bgp_path ~ BOGON_ASNS then return true; # 如果路径包含保留ASN则返回true</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    case net.type {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        NET_IP4: return net.len &gt; 24 || net ~ BOGON_PREFIXES_V4; # IPv4 CIDR 大于 /24 为太长</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        NET_IP6: return net.len &gt; 48 || net ~ BOGON_PREFIXES_V6; # IPv6 CIDR 大于 /48 为太长</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        else: print &quot;unexpected net.type &quot;, net.type, &quot; &quot;, net; return false; # 保底，一般不应该出现非IP4/IP6的前缀。</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">filter peer_import_filter_v6 {    # 生成一个专用于Peering对等会话的导入过滤器</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    if genreal_check() then reject;        # 无法通过上面的基础检测的函数应该处理掉</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    if irr_check() then reject;            # 对该路由进行IRR检测 (IRR检测的函数定义以及数据集建立方法：附录-IRR RPKI服务的搭建和使用)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    if rpki_invalid_check() then reject;   # 对RPKI进行检测 (RPKI检测的函数定义以及数据集建立方法：附录-IRR RPKI服务的搭建和使用)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    if bgp_path.first != PEER_ASN then reject;    # 对BGP_Path.first 进行检测，如果发现错误就应当拒绝，虽然一般情况下不会出现这种情况</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    accept;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">filter peer_export_filter_v6 {    # 生成一个专用于Peering对等会话的导出过滤器</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    if proto ~ &quot;transit_*&quot; then reject;    # 直接匹配配置名称，直接过滤上游来的路由，transit_* 应根据自己的实际情况修改</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    if proto ~ &quot;peer_*&quot; then reject;       # 直接匹配配置名称，直接过滤其他对等来的路由，peer_* 应根据自己的实际情况修改</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    if general_check() then reject;        # 网络中可能存在一些自定义的Bogon，添加此函数可以保底</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    # ... 你也可以在这里添加一些自定义的函数或判断条件</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    accept;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/sundry/start-your-bgp-session"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">1. 建立 BGP Session</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/sundry/build-inet"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">3. 建立内网</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#公网路由应遵守的规则" class="table-of-contents__link toc-highlight">公网路由应遵守的规则</a><ul><li><a href="#专有名词概念解释-" class="table-of-contents__link toc-highlight">专有名词概念解释 <a href="#gai-nian" id="gai-nian"></a></a></li></ul></li><li><a href="#bird-的基础语法解释-" class="table-of-contents__link toc-highlight">BIRD 的基础语法解释 <a href="#guo-lv-qi" id="guo-lv-qi"></a></a></li><li><a href="#与对等-peering-连接的过滤器定义" class="table-of-contents__link toc-highlight">与对等 (Peering) 连接的过滤器定义</a></li></ul></div></div></div></div></main></div></div></div>
<script src="/assets/js/runtime~main.7771ef0e.js"></script>
<script src="/assets/js/main.f3588879.js"></script>
</body>
</html>